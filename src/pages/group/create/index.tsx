import { usePost } from "@/apis/hooks";
import { DefaultLayout } from "@/components";
import { ApiRoutes, PageRoutes } from "@/constants";
import { CreatePanel, GroupForm } from "@/containers";
import { CreateGroupFormValues } from "@/types";
import { toUrl } from "@/utils";
import { Box, Flex } from "@chakra-ui/react";
import { keyframes } from "@emotion/react";
import Head from "next/head";
import { useRouter } from "next/router";
import { useCallback } from "react";
import { useForm } from "react-hook-form";

export const initialFormValues: CreateGroupFormValues = {
  name: "",
  category: "",
  description: "",
  minimum_age: 0,
  maximum_age: 100,
  capacity: 10,
  sex: true,
  images: [],
};

export const bgColorAnimation = keyframes`
  from {
    width: 0;
    height: 0;
  }
  to {
    width:85%;
    height:100%;
  }
`;

const CreateGroup = () => {
  const router = useRouter();
  const { register, handleSubmit, setValue, watch, getValues } =
    useForm<CreateGroupFormValues>({
      defaultValues: initialFormValues,
    });

  const { mutate: postClub } = usePost(toUrl(ApiRoutes.Group));

  const onSubmit = useCallback(
    (data: CreateGroupFormValues) => {
      const { category, ...rest } = data;
      const modifiedData = {
        ...rest,
        categories: [Number(category)],
        sex: getValues("sex"),
        images: [],
      };
      postClub(modifiedData, {
        onSuccess: async (data) => {
          const clubId = data.data;
          router.push(toUrl(PageRoutes.GroupHome, { id: clubId }));
        },
      });
    },
    [getValues, postClub, router]
  );

  return (
    <>
      <Head>
        <title>Join Us - CreateGroup</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <DefaultLayout>
        <Flex
          position={"relative"}
          boxShadow={"lg"}
          as={"form"}
          onSubmit={handleSubmit(onSubmit)}
          my={16}
          direction={{ base: "column", xl: "row" }}
          borderRadius={{ base: "2xl", xl: "none" }}
        >
          <Box
            zIndex={0}
            position={"absolute"}
            w={{ base: "100%", xl: "85%" }}
            h={{ base: "60%", xl: "100%" }}
            bgColor={"primary.500"}
            borderBottomRightRadius={"max(50rem,50rem)"}
            borderTopLeftRadius={"max(0,50rem)"}
            animation={`${bgColorAnimation} 1s ease-in-out`}
          />

          <CreatePanel />
          <GroupForm register={register} watch={watch} setValue={setValue} />
        </Flex>
      </DefaultLayout>
    </>
  );
};

export default CreateGroup;
